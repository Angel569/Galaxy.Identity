@page "/usuarios"
@using Galaxy.Keycloak.Blazor.Dto
@using Galaxy.Keycloak.Blazor.Services
@using Microsoft.AspNetCore.Authorization
@layout MainLayout
@attribute [Authorize]
@inject HttpClient Http
@inject UsuarioService UsuarioService

<PageTitle>Usuarios</PageTitle>
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="container py-4">
        <div class="alert alert-danger mt-4">@errorMessage</div>
    </div>
}
else
{
    <div class="container py-4">
        <h1 class="mb-4 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-people-fill me-2"></i>Usuarios</span>
            <button class="btn btn-primary" @onclick="ShowModal">Crear Usuario</button>
        </h1>
        <!-- Modal -->
        @if (showModal)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5)">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Crear Usuario</h5>
                            <button type="button" class="btn-close" @onclick="HideModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input class="form-control" @bind="user.Username" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input class="form-control" @bind="user.Email" type="email" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Contraseña</label>
                                <input class="form-control" @bind="user.Password" type="password" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="HideModal">Cancelar</button>
                            <button class="btn btn-primary" @onclick="CreateUser">Crear</button>
                        </div>
                    </div>
                </div>
            </div>
        }
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                            
                                <th class="px-4 py-3">Usuario</th>
                                <th class="px-4 py-3">Email</th>
                                <th class="px-4 py-3">Fecha de Creación</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in users)
                            {
                                <tr>
                                
                                    <td class="px-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center"
                                                    style="width: 40px; height: 40px;">
                                                <strong class="text-primary">@user.Username.Substring(0, 1).ToUpper()</strong>
                                            </div>
                                            <div class="ms-3">
                                                <div class="fw-semibold">@user.Username</div>
                                                <small class="text-muted">@user.Id.Substring(0, 8)...</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-envelope text-muted me-2"></i>
                                            <span>@user.Email</span>
                                        </div>
                                    </td>                            
                                    <td class="px-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar3 text-muted me-2"></i>
                                            <small>@user.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                        </div>
                                    </td>
                               
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            
            </div>
        </div>
    </div>
}

@code {
    private List<UserResponse> users = new();
    private string? errorMessage;
    private bool showModal = false;
    private CreateUserRequest user = new();

    protected override async Task OnInitializedAsync()
    {      
        var result = await UsuarioService.GetUsuariosAsync();
        if (result.IsSuccess)
        {
            users = result.Result ?? new();
        }
        else
        {
            errorMessage = result.Message;
        }
    }
    private void ShowModal() => showModal = true;
    private void HideModal()
    {
        showModal = false;
        user = new();
    }

    private async Task CreateUser()
    {
        var createResult = await UsuarioService.CrearUsuarioAsync(user);
        if (!createResult.IsSuccess)
        {
            errorMessage = createResult.Message;
        }
        else
        {
            HideModal();
            var result = await UsuarioService.GetUsuariosAsync();
            if (result.IsSuccess)
            {
                users = result.Result ?? new();
                errorMessage = null;
                user = new CreateUserRequest();
            }
            else
            {
                errorMessage = result.Message;
            }
        }   
    }
}
